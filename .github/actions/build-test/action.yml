---
name: 'build-test'
description: 'Composite action to build and test Web3Signer'

runs:
  using: "composite"
  steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'
        fetch-depth: 0

    - name: Fetch Tags
      run: git fetch --tags --force origin #workaround https://github.com/actions/checkout/issues/882
      shell: bash

    - name: Set up JDK 21
      uses: actions/setup-java@v4.2.1
      with:
        java-version: 21
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4

    - name: set up docker buildx
      uses: docker/setup-buildx-action@v3

    - name: Print Version
      run:  ./gradlew -q printVersion
      shell: bash

    - name: Build and unit test
      run: ./gradlew build
      shell: bash

    - name: Integration Tests
      run: ./gradlew integrationTest
      shell: bash

    - name: Acceptance Tests
      run: ./gradlew acceptanceTest
      shell: bash

    # TODO: Take docker out completely from gradle
    - name: Test Docker Image
      run: ./gradlew testDocker
      shell: bash

    - name: Summarize tests results
      uses: jeantessier/test-summary-action@v1.0.7
      if: always()

    - name: Upload build reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: build-reports
        path: '**/build/reports/'